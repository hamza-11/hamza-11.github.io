<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿØÿ±ÿØÿ¥ÿ©</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Almarai&display=swap">

    <style>
        body {
            font-family: 'Almarai', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #111;
            color: white;
        }

        .header {
            background-color: #222;
            color: white;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #333;
        }

        .header img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .header button {
            background: red;
            border: none;
            padding: 8px 14px;
            border-radius: 10px;
            cursor: pointer;
            color: white;
        }

        #chat {
            flex: 1;
            height: calc(100vh - 120px);
            overflow-y: auto;
            padding: 15px;
            background-color: #000;
        }

        .message {
            display: flex;
            margin-bottom: 12px;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received {
            justify-content: flex-start;
        }

        .bubble {
            max-width: 60%;
            padding: 12px 15px;
            border-radius: 15px;
            background-color: #333;
            color: white;
        }

        .message.sent .bubble {
            background-color: #075e54;
        }

        .timestamp {
            font-size: 11px;
            color: #bbb;
            margin-top: 5px;
        }

        #messageInputContainer {
            background: #222;
            padding: 12px;
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            padding: 12px;
            border-radius: 20px;
            border: none;
            background: #333;
            color: white;
        }

        button {
            background: #25d366;
            border: none;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            color: white;
        }

        img.chat-img {
            max-width: 100%;
            border-radius: 10px;
            margin-bottom: 5px;
        }
    </style>

</head>
<body dir="rtl">

    <div class="header">
        <div style="display:flex;align-items:center;">         
        </div>

        <button onclick="deleteChat()">ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©</button>
    </div>

    <div id="chat"></div>

    <div id="messageInputContainer">
        <input id="messageInput" type="text" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ™ŸÉ...">
        <input id="imageInput" type="file" style="display:none" accept="image/*">
        <button onclick="document.getElementById('imageInput').click()">üì∑</button>
        <button onclick="sendMessage()">‚û§</button>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-database.js"></script>

    <script>

        /* ---------------------- Firebase ---------------------- */

        const firebaseConfig = {
            apiKey: "AIzaSyByTnOxAhiNYbytuZV4pJT5Kwm6LcsSMzg",
            authDomain: "chatz-da38d.firebaseapp.com",
            databaseURL: "https://chatz-da38d-default-rtdb.firebaseio.com",
            projectId: "chatz-da38d",
            storageBucket: "chatz-da38d.appspot.com",
            messagingSenderId: "681805463840",
            appId: "1:681805463840:web:2b90061ef8a9d7dd7a9745"
        };

        firebase.initializeApp(firebaseConfig);
        const chatRef = firebase.database().ref("chat");

        const chatDiv = document.getElementById("chat");

        const currentUser = prompt("ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±");
        const otherUser = currentUser === "ÿ≠ŸÖÿ≤ÿ©" ? "ÿ≠ÿ®Ÿäÿ®ÿ©" : "ÿ≠ŸÖÿ≤ÿ©";

        /* ---------------------- ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿØÿ±Ÿäÿ¨Ÿä ---------------------- */

        let messages = [];
        let loadedCount = 5;

        chatRef.on("value", snapshot => {
            messages = [];
            snapshot.forEach(child => {
                let msg = child.val();
                msg.id = child.key;

                if (
                    (msg.sender === currentUser && msg.receiver === otherUser) ||
                    (msg.sender === otherUser && msg.receiver === currentUser)
                ) {
                    messages.push(msg);
                }
            });

            renderMessages();
        });

        function renderMessages() {
            chatDiv.innerHTML = "";
            let start = Math.max(messages.length - loadedCount, 0);
            let visible = messages.slice(start);

            visible.forEach(msg => displayMessage(msg));
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≤ŸäÿØ ÿπŸÜÿØ ÿßŸÑÿ≥ÿ≠ÿ® ŸÑŸÑÿ£ÿπŸÑŸâ
        chatDiv.addEventListener("scroll", () => {
            if (chatDiv.scrollTop === 0 && loadedCount < messages.length) {
                loadedCount += 5;
                renderMessages();
            }
        });

        /* ---------------------- ÿπÿ±ÿ∂ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ---------------------- */

        function displayMessage(msg) {
            const div = document.createElement("div");
            div.className = "message " + (msg.sender === currentUser ? "sent" : "received");

            const bubble = document.createElement("div");
            bubble.className = "bubble";

            if (msg.image) {
                let image = document.createElement("img");
                image.src = msg.image;
                image.className = "chat-img";
                bubble.appendChild(image);
            }

            if (msg.text) {
                let text = document.createElement("p");
                text.textContent = msg.text;
                bubble.appendChild(text);
            }

            let time = document.createElement("div");
            time.className = "timestamp";
            time.textContent = new Date(msg.timestamp).toLocaleString();
            bubble.appendChild(time);

            div.appendChild(bubble);
            chatDiv.appendChild(div);
        }

        /* ---------------------- ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ---------------------- */

        document.getElementById("imageInput").addEventListener("change", e => {
            let file = e.target.files[0];
            let reader = new FileReader();

            reader.onload = function(ev) {
                pushMessage(null, ev.target.result);
            };

            reader.readAsDataURL(file);
        });

        function sendMessage() {
            let text = document.getElementById("messageInput").value.trim();
            if (text !== "") {
                pushMessage(text, null);
                document.getElementById("messageInput").value = "";
            }
        }

        function pushMessage(text, image) {
            chatRef.push({
                text,
                image,
                sender: currentUser,
                receiver: otherUser,
                timestamp: Date.now()
            });
        }

        /* ---------------------- ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿßÿ™ ---------------------- */

        function deleteChat() {
            if (confirm("ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑÿü")) {
                chatRef.remove();
                chatDiv.innerHTML = "";
            }
        }

    </script>

</body>
</html>
